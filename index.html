<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>凝聚｜2026 感謝祭｜回饋表單</title>

  <script src="[https://static.line-scdn.net/liff/edge/2/sdk.js](https://static.line-scdn.net/liff/edge/2/sdk.js)"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif; background: #f8fafc; min-height: 100vh; }
    header { padding: 16px; text-align: center; }
    header h1 { margin: 0 0 6px; font-size: 18px; }
    header p { margin: 0; font-size: 13px; color: #64748b; }
    .frame-wrap { margin: 0 auto; max-width: 980px; padding: 0 12px 24px; }
    .loading { background: #fff; border-radius: 12px; border: 1px solid #e5e7eb; padding: 18px; color: #475569; font-size: 14px; text-align: center; display: none; }
    iframe { width: 100%; height: calc(100vh - 120px); border: 0; background: #fff; border-radius: 12px; display: none; }
    
    /* Modal Styles */
    .fullscreen-modal { display: none; position: fixed; inset: 0; z-index: 9999; background: #f8fafc; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 24px; }
    .fullscreen-modal.show { display: flex; }
    .icon-box { width: 80px; height: 80px; background: #06c755; border-radius: 20px; display: grid; place-items: center; margin-bottom: 24px; box-shadow: 0 10px 25px -5px rgba(6, 199, 85, 0.4); }
    .fullscreen-modal h2 { margin: 0 0 12px; font-size: 20px; color: #1e293b; font-weight: 700; }
    .fullscreen-modal p { color: #64748b; margin: 0 0 24px; line-height: 1.6; font-size: 15px; max-width: 400px; }
    .btn-primary { background: #06c755; color: #fff; font-weight: bold; padding: 14px 32px; border-radius: 50px; text-decoration: none; font-size: 16px; box-shadow: 0 4px 12px rgba(6, 199, 85, 0.3); border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .btn-primary:active { transform: scale(0.98); }
    .btn-secondary { margin-top: 20px; background: transparent; color: #94a3b8; font-size: 14px; border: none; text-decoration: underline; cursor: pointer; }
    .qr-frame { background: #fff; padding: 12px; border-radius: 16px; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 24px; }
    .qr-frame img { width: 200px; height: 200px; display: block; }
  </style>
</head>
<body>
  <header></header>
  
  <div class="frame-wrap">
    <div id="loadingBox" class="loading">請稍等載入… </div>
    <iframe id="filloutFrame" title="Fillout 表單"></iframe>
  </div>

  <div id="qrModal" class="fullscreen-modal" role="dialog" aria-modal="true">
    <div class="icon-box">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><path d="M3 3h6v6H3V3zm2 2v2h2V5H5zm8-2h6v6h-6V3zm2 2v2h2V5h-2zM3 13h6v6H3v-6zm2 2v2h2v-2H5zm13-2h3v2h-3v-2zm-3 0h2v2h-2v-2zm3 3h3v3h-3v-3zm-6 0h2v1h1v2h-3v-3zm3 3v3h3v-3h-3z" /></svg>
    </div>
    <h2>請使用手機掃描</h2>
    <p>請開啟手機相機或 LINE App 掃描下方條碼</p>
    <div class="qr-frame"><img id="qrImage" alt="QR Code"></div>
  </div>

  <div id="mobileRedirectModal" class="fullscreen-modal">
    <div class="icon-box">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="white"><path d="M21.6 11.2c0-4.6-4.3-8.4-9.6-8.4S2.4 6.6 2.4 11.2c0 4.1 3.6 7.6 8.4 8.2v0.1l-1.2 3.8c-0.1 0.4 0.2 0.7 0.5 0.7 0.2 0 0.3-0.1 0.4-0.1l4.9-3.4h0.1c3.5-0.6 6.1-4.1 6.1-8.3z" /></svg>
    </div>
    <h2>點擊按鈕開啟表單</h2>
    <p>請點擊下方按鈕切換至 LINE。</p>
    <a id="openLineBtn" href="#" class="btn-primary">點我開始填寫</a>
    <button id="stayHereBtn" class="btn-secondary">沒有 LINE？點我繼續填寫</button>
  </div>

  <script>
    /***** 請確認您的設定 *****/
    const LIFF_ID = "2001467446-5e8NpLdt";
    const FILL_OUT_BASE_URL = "[https://cicostudio.fillout.com/t/6daWfoG9sJus?userid=xxxxx](https://cicostudio.fillout.com/t/6daWfoG9sJus?userid=xxxxx)";
    /********************************/

    const ua = navigator.userAgent || "";
    const isLINE = /line/i.test(ua);
    const isMobile = /iPhone|iPad|iPod|Android/i.test(ua);

    const frame = document.getElementById("filloutFrame");
    const loadingBox = document.getElementById("loadingBox");
    const desktopModal = document.getElementById("qrModal");
    const qrImg = document.getElementById("qrImage");
    const mobileModal = document.getElementById("mobileRedirectModal");
    const openLineBtn = document.getElementById("openLineBtn");
    const stayHereBtn = document.getElementById("stayHereBtn");

    function buildFormUrl(params = {}) {
      const url = new URL(FILL_OUT_BASE_URL);
      Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== "") url.searchParams.set(k, v);
      });
      return url.toString();
    }

    function mountIframe(src) {
      frame.src = src;
      frame.style.display = "block";
      loadingBox.style.display = "none";
    }

    // --- Desktop QR Modal ---
    function showQRModal() {
      // 修正：移除多餘的換行
      qrImg.src = "[https://api.qrserver.com/v1/create-qr-code/?data=](https://api.qrserver.com/v1/create-qr-code/?data=)" + 
                  "https://liff.line.me/2001467446-5e8NpLdt?openExternalBrowser=1" + "&size=240x240";
      desktopModal.classList.add("show");
    }

    // --- Mobile Redirect Modal ---
    function showMobileRedirect() {
      // 修正：移除 https: // 中間的空白
      const liffUrl = `https://liff.line.me/${LIFF_ID}`;
      openLineBtn.href = liffUrl;
      mobileModal.classList.add("show");
    }

    stayHereBtn.addEventListener("click", () => {
      mobileModal.classList.remove("show");
      mountIframe(buildFormUrl());
    });

    (async function init() {
      // 1. 如果是 LINE App 內：走標準 LIFF 流程
      if (isLINE) {
        loadingBox.style.display = "block";
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }
          const profile = await liff.getProfile();
          const url = buildFormUrl({ userid: profile.userId });
          mountIframe(url);
        } catch (err) {
          console.error("LIFF error:", err);
          // 失敗時仍顯示表單，避免空白
          mountIframe(buildFormUrl());
        }
        return;
      }

      // 2. 如果是 Mobile (非 LINE)：嘗試切換到 LINE
      if (isMobile) {
        const hasRedirected = sessionStorage.getItem("liff_redirect_attempted");
        if (!hasRedirected) {
          sessionStorage.setItem("liff_redirect_attempted", "1");
          // 修正：移除 https: // 中間的空白
          window.location.replace(`https://liff.line.me/${LIFF_ID}`);
          return;
        } else {
          showMobileRedirect();
          mountIframe(buildFormUrl());
          return;
        }
      }

      // 3. Desktop：直接載入一般表單 + 彈 QR Code
      mountIframe(buildFormUrl());
      if (!sessionStorage.getItem("qr_dismissed")) {
        showQRModal();
      }
    })();
  </script>
</body>
</html>
