<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>用 LINE 開啟</title>

  <!-- iOS：避免快取造成重複狀態 -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />

  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC","PingFang TC"; margin:0; background:#f6f7fb; }
    .wrap { max-width:560px; margin:0 auto; padding:20px; }
    .card { background:#fff; border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    h1 { font-size:18px; margin:0 0 10px; }
    p { margin:8px 0; line-height:1.6; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button { border:0; border-radius:12px; padding:12px 14px; font-size:15px; font-weight:700; cursor:pointer; }
    .primary { background:#06c755; color:#fff; }
    .ghost { background:#eef1f6; }
    .hint { font-size:13px; color:#666; }
    iframe { width:100%; height:72vh; border:0; border-radius:16px; margin-top:14px; background:#fff; }
    .mono { font-family:ui-monospace; font-size:12px; background:#f3f4f6; padding:10px; border-radius:12px; word-break:break-all; }
  </style>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>請用 LINE 開啟</h1>
    <p id="status" class="hint">檢測中…</p>

    <div id="actions" class="btns">
      <button id="openInLine" class="primary">用 LINE 開啟</button>
      <button id="copyLink" class="ghost">複製連結</button>
    </div>

    <p class="hint">目前頁面連結：</p>
    <div id="pageUrl" class="mono"></div>
  </div>

  <iframe id="formFrame" title="form" loading="lazy"></iframe>
</div>

<script>
  /* ========= 已填入你的參數 ========= */
  const LIFF_ID = "2001467446-5e8NpLdt";
  // 只保留 utm_source / utm_medium / utm_campaign（first-touch）
  const ATTR_KEYS = ["utm_source", "utm_medium", "utm_campaign"];
  // Fillout base：userid= 後面會自動換成 LINE userId
  const FILL_OUT_BASE_URL = "https://cicostudio.fillout.com/t/6daWfoG9sJus?userid=";
  /* ================================= */

  const liffUrl = `https://liff.line.me/${LIFF_ID}`;
  const pageUrl = location.href;

  const $status = document.getElementById("status");
  const $openInLine = document.getElementById("openInLine");
  const $copyLink = document.getElementById("copyLink");
  const $actions = document.getElementById("actions");
  const $frame = document.getElementById("formFrame");
  document.getElementById("pageUrl").textContent = pageUrl;

  /* ========= 強化①：從 LIFF 回來就不再顯示引導 ========= */
  const fromLiff =
    (document.referrer || "").includes("liff.line.me") ||
    sessionStorage.getItem("__from_liff__") === "1";

  if (fromLiff) {
    sessionStorage.setItem("__from_liff__", "1");
    $actions.style.display = "none";
    $status.textContent = "已嘗試由 LINE 開啟，若未成功可直接填寫。";
  }

  /* ========= 歸因：只保留 3 個 UTM（first-touch） ========= */
  function parseQuery(search) {
    const p = new URLSearchParams(search || "");
    const obj = {};
    for (const k of ATTR_KEYS) {
      const v = p.get(k);
      if (v) obj[k] = v;
    }
    return obj;
  }

  function mergeAttr(prev, next) {
    const out = { ...(prev || {}) };
    for (const [k, v] of Object.entries(next || {})) {
      if (!v) continue;
      if (!out[k]) out[k] = v; // first-touch
    }
    return out;
  }

  function getAttr() {
    const stored = sessionStorage.getItem("__attr__");
    let prev = {};
    try { if (stored) prev = JSON.parse(stored); } catch {}

    const now = parseQuery(location.search);
    const merged = mergeAttr(prev, now);
    sessionStorage.setItem("__attr__", JSON.stringify(merged));
    return merged;
  }

  function attrToQueryString(attrObj) {
    const p = new URLSearchParams();
    for (const [k, v] of Object.entries(attrObj || {})) {
      if (v) p.set(k, v);
    }
    return p.toString();
  }

  const attr = getAttr();

  /* ========= 組裝 Fillout URL：帶 userid + 3 個 UTM ========= */
  function buildFilloutUrl(userId) {
    const base = userId
      ? `${FILL_OUT_BASE_URL}${encodeURIComponent(userId)}`
      : FILL_OUT_BASE_URL;

    const qs = attrToQueryString(attr);
    if (!qs) return base;

    // base 已經有 ?userid=... 所以接 &utm_...
    return `${base}${base.includes("?") ? "&" : "?"}${qs}`;
  }

  function mountIframe(userId) {
    $frame.src = buildFilloutUrl(userId);
  }

  /* ========= LIFF init：在 LINE 內就取 userId ========= */
  async function tryInitLIFF() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isInClient()) throw new Error("not in client");

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      mountIframe(profile.userId);
      $status.textContent = "已在 LINE 內，成功取得 userId（已帶入 UTM）";
    } catch (e) {
      // 不在 LINE 內：外部也先載入表單（無 userId）
      mountIframe();
      if (!fromLiff) $status.textContent = "請點擊「用 LINE 開啟」（iOS 建議用 Safari）";
    }
  }

  /* ========= 強化②：複製 Landing Page 本身（含 UTM/參數） ========= */
  $copyLink.onclick = async () => {
    try {
      await navigator.clipboard.writeText(pageUrl);
      alert("已複製本頁連結（含 UTM 參數），可貼到 Safari 或 LINE 再開啟");
    } catch {
      prompt("請手動複製", pageUrl);
    }
  };

  /* ========= iOS 最穩：只在使用者點擊時才跳 LIFF ========= */
  $openInLine.onclick = (e) => {
    e.preventDefault();
    sessionStorage.setItem("__from_liff__", "1");
    getAttr(); // 點擊前再快照一次 UTM

    // 使用者手勢觸發：成功率最高
    window.location.href = liffUrl;

    // iOS 保底：部分 WebView 對同頁導向怪，補一個 open
    setTimeout(() => {
      try { window.open(liffUrl, "_blank", "noopener,noreferrer"); } catch (_) {}
    }, 150);
  };

  /* ========= 啟動 ========= */
  // 外部先載入表單，避免空白等待
  mountIframe();
  // 若已在 LINE / LIFF WebView，會自動拿到 userId 再刷新 iframe
  tryInitLIFF();
</script>
</body>
</html>
